' Gambas class file

Private resultadoAlumno As Result
Private resultadoCurso As Result

Public ControladorAplicacion As Controlador

Public Sub Form_Open()
  'formatear gridviews...
  
  Dim alu As New Alumnodao
  Dim curs As New Cursodao
  
  alu.gridFormatearColumnas(GridViewAlumno)
  regillaAlumno()
  curs.gridFormatearColumnas(GridViewCurso)
  regillaCurso()
  ListBoxInforme.Add("Lista de Alumnos")
  ListBoxInforme.Add("Lista de Alumnos con los cursos que participan")
  ListBoxInforme.Add("Lista de Cursos")
  ListBoxInforme.Add("Lista de Cursos y Alumnos que lo conforman ")
  ListBoxInforme.Add("Expediente de Alumno determinado con lista de Cursos")
  ListBoxInforme.Add("Expediente de Curso determinado con lista de Alumnos")
  'relleno el gridview de datos...
  RefrescarDatosAlumnos()
  'relleno el gridview de datos...
  RefrescarDatosCursos()
  
End

'para el tema de dimensionado del formulario
Public Sub Form_Resize()
  
  IconPanelMenu.W = Me.w - IconPanelMenu.X
  IconPanelMenu.h = Me.H - IconPanelMenu.y - 10
  
  GridViewAlumno.w = Me.w - GridViewAlumno.X - IconPanelMenu.X - 30
  GridViewAlumno.h = Me.H - GridViewAlumno.y - IconPanelMenu.y - 10
  
  GridViewCurso.w = Me.w - GridViewcurso.X - IconPanelMenu.X - 30
  GridViewCurso.h = Me.H - GridViewCurso.y - IconPanelMenu.y - 10
  ListBoxInforme.h = Me.H - ListBoxInforme.y - IconPanelMenu.y - 10
  
End
'--------------------------------------------------------------------
'botones
'--------------------------------------------------------------------

Public Sub ToolButtonAnadir_Click()
  
  Dim nuevoalumno As New Alumnovo
  
  nuevoalumno.idAlumno = 0 'para que sea a añadir
  ControladorAplicacion.falumno.TmpAlumno = nuevoalumno
  ControladorAplicacion.falumno.showmodal()
  ControladorAplicacion.falumno.TmpAlumno = Null
  'relleno el gridview de datos...
  RefrescarDatosAlumnos()
  
End

Public Sub ToolButtonAnadirCurso_Click()
  
  Dim nuevoCurso As New CursoVO
  
  nuevoCurso.idCurso = 0
  ControladorAplicacion.fcurso.tmpcurso = nuevoCurso
  ControladorAplicacion.fcurso.showmodal()
  ControladorAplicacion.fcurso.tmpcurso = Null
  'relleno el gridview de datos...
  RefrescarDatosCursos()
  
End

Public Sub ToolButtonEditar_Click()
  
  Dim alu As New AlumnoVO
  
  If GridViewAlumno.row = -1 Then 
    'no puedo editar ya que no esta el cursor puesto en el gridvies
    Message.Info("Seleccione un alumno")
  Else
    alu = ControladorAplicacion.BuscarIdalumno(Val(GridViewAlumno[GridViewAlumno.row, 1].Text))
    ControladorAplicacion.falumno.TmpAlumno = alu
    ControladorAplicacion.falumno.TmpAlumno.idAlumno = GridViewAlumno[GridViewAlumno.row, 1].Text
    
    ControladorAplicacion.falumno.showmodal()
    ControladorAplicacion.falumno.TmpAlumno = Null
    'relleno el gridview de datos...
    RefrescarDatosAlumnos()
  Endif
  
End

Public Sub ToolButtonEditarCurso_Click()
  
  Dim cur As New CursoVO
  
  If GridViewCurso.row = -1 Then 
    Message.Info("Seleccione un curso")
  Else
    cur = ControladorAplicacion.BuscarIdCurso(Val(GridViewCurso[GridViewCurso.row, 0].Text))
    ControladorAplicacion.fcurso.TmpCurso = cur
    ControladorAplicacion.fcurso.TmpCurso.idCurso = GridViewCurso[GridViewCurso.row, 0].Text
    ControladorAplicacion.fcurso.showmodal()
    ControladorAplicacion.fcurso.TmpCurso = Null
    'relleno el gridview de datos...
    
    RefrescarDatosCursos()
  Endif  
  
End

Public Sub ToolButtonBorrar_Click()
  
  Dim valor As Integer
  
  If GridViewAlumno.row = -1 Then 
    'no puedo editar ya que no esta el cursor puesto en el gridvies
    Message.Info("Seleccione un alumno")
  Else
    valor = Message.Question("¿quieres borrar un alumno? " & gb.CrLf & "Si lo borras, borraras los datos de los cursos en que ha estado", "aceptar", "cancelar")
    If valor = 1 Then 
      If ControladorAplicacion.log.borrarIdAlumno(Val(GridViewAlumno[GridViewAlumno.row, 1].Text)) Then 
        'relleno el gridview de datos...
        RefrescarDatosAlumnos()
      Else
        Message.Info("Ha habido un problema al borrar el alumno")
      Endif
      
    Endif
    
  Endif
  
End

Public Sub ToolButtonBorrarCurso_Click()
  
  Dim valor As Integer
  
  If GridViewcurso.row = -1 Then 
    'no puedo editar ya que no esta el cursor puesto en el gridvies
    Message.Info("Seleccione un curso")
  Else
    valor = Message.Question("¿quieres borrar un curso? " & gb.CrLf & "Si lo borras, borraras los datos de los alumnos que lo han cursado", "aceptar", "cancelar")
    If valor = 1 Then 
      If ControladorAplicacion.log.borrarIdCurso(Val(GridViewCurso[GridViewCurso.row, 0].Text)) Then 
        'relleno el gridview de datos...
        RefrescarDatosCursos()
      Else
        Message.Info("Ha habido un problema al borrar el alumno")
      Endif
      
    Endif
    
  Endif
  
End

'------------------------------------------------------------------
'IconPanelMenu
'------------------------------------------------------------------

Public Sub IconPanelMenu_Click()
  
  Select Case IconPanelMenu.Index
    Case 4
      'cambio de contraseña
      LabelMensajeClave.text = "mensaje:"
      TextBoxUsuarioActual.text = ""
      TextBoxClaveActual.text = ""
      TextBoxClaveNueva.text = ""
      TextBoxClaveReescrita.text = ""
    Case 5
      'salir del programa
      Me.Close()
  End Select
  
End

'----------------------------------------------------------------------
'Zona de Administrador....
'----------------------------------------------------------------------
Public Sub ButtonCambiarClave_Click()
  
  If TextBoxClaveNueva.text = TextBoxClaveReescrita.text Then 
    
    If ControladorAplicacion.comprobarUsuarioPassword(TextBoxUsuarioActual.text, TextBoxClaveActual.text) Then 
      ControladorAplicacion.actualizarPassword(TextBoxUsuarioActual.text, TextBoxClaveNueva.text)
      LabelMensajeClave.text = "mensaje: ok se ma modificado la contraseña"
      TextBoxUsuarioActual.text = ""
      TextBoxClaveActual.text = ""
      TextBoxClaveNueva.text = ""
      TextBoxClaveReescrita.text = ""
    Else
      LabelMensajeClave.text = "mensaje: no coincide la contraseña Actual"
    Endif
    
  Else
    
    LabelMensajeClave.text = "mensaje: las clave Nueva no coincide con la Reescrita"
  Endif
  
End

Public Sub ToolButtonExpedienteCurso_Click()
  
  Dim cur As New CursoVO
  
  If GridViewCurso.row = -1 Then 
    'no puedo editar ya que no esta el cursor puesto en el gridvies
    Message.Info("Seleccione un curso")
  Else
    cur = ControladorAplicacion.BuscarIdCurso(Val(GridViewCurso[GridViewCurso.row, 0].Text))
    ControladorAplicacion.fExpCurso.TmpCurso = cur
    'para parsar el id del curso elegido...
    cur.idCurso = Val(GridViewCurso[GridViewCurso.row, 0].Text)
    ControladorAplicacion.fExpCurso.ShowModal()
    
  Endif
  
End

Public Sub ToolButtonExpediente_Click()
  
  Dim alu As New AlumnoVO
  
  If GridViewAlumno.row = -1 Then 
    'no puedo editar ya que no esta el cursor puesto en el gridvies
    Message.Info("Seleccione un alumno")
  Else
    
    alu = ControladorAplicacion.BuscarIdalumno(Val(GridViewAlumno[GridViewAlumno.row, 1].Text))
    alu.idAlumno = Val(GridViewAlumno[GridViewAlumno.row, 1].Text)
    ControladorAplicacion.fexpAlumno.TmpAlumno = alu
    ControladorAplicacion.fexpAlumno.ShowModal()
  Endif
  
End

'-------------------------- Actualizacion datos gridview-------------------------
Public Sub GridViewAlumno_Data(row As Integer, column As Integer)
  ' este evento se encarga de dibujar los datos en el gridviews, para que aparezcan en la pantalla.
  
  Dim valorfecha As String
  
  resultadoAlumno.MoveTo(row)
  
  'la columna IdAlumno la oculto en la definicion...
  ' If column = 1 Then 
  '  'ancho de la columna IdAlumno
  '  GridViewAlumno.Columns[1].width = 0
  'Endif
  If column = 0 Then 
    If Exist(ControladorAplicacion.rutaTrabajo & "MiniFotos/Mini" & resultadoAlumno[GridViewAlumno.Columns[column].text]) Then 
      GridViewAlumno.Data.Picture = Picture.Load(ControladorAplicacion.rutaTrabajo & "MiniFotos/Mini" & resultadoAlumno[GridViewAlumno.Columns[column].text])
      Return 
    Else
      GridViewAlumno.Data.text = ""
      Return
    Endif
  Endif
  If GridViewAlumno.Columns[column].text <> "FechaNacimiento" Then 
    'no es una fecha
    GridViewAlumno.Data.text = Str(resultadoAlumno[GridViewAlumno.Columns[column].text])
  Else 
    'presentacion de fecha
    ValorFecha = resultadoAlumno[GridViewAlumno.Columns[column].text]
    GridViewAlumno.Data.text = Format(Date(Year(ValorFecha), Month(ValorFecha), Day(ValorFecha)), "dd-mmmm-yyyy")
    
  Endif
  ' colorea la fila, según sea par o impar
  If row = GridViewAlumno.row Then 
    'cursor donde esta situado en el gridview
    GridViewAlumno.Data.Background = Color.Orange
  Else
    
    If row Mod 2 = 0 Then GridViewAlumno.Data.Background = Color.LightBackground
  Endif
  
End

Public Sub RefrescarDatosAlumnos()
  
  resultadoAlumno = ControladorAplicacion.ContenidoAlumnos()
  GridViewAlumno.Rows.count = 0 'lo ponemos a cero el numero de filas
  GridViewAlumno.Rows.count = resultadoAlumno.count 'actualizamso al resultado de la consulta
  
End

Public Sub RefrescarDatosCursos()
  
  resultadoCurso = ControladorAplicacion.ContenidoCurso()
  GridViewCurso.Rows.count = 0 'lo ponemos a cero el numero de filas
  GridViewCurso.Rows.count = resultadoCurso.count 'actualizamso al resultado de la consulta
  
End

Public Sub GridViewCurso_Data(row As Integer, column As Integer)
  ' este evento se encarga de dibujar los datos en el gridviews, para que aparezcan en la pantalla.
  
  resultadoCurso.MoveTo(row)
  GridViewCurso.Data.text = Str(resultadoCurso[GridViewCurso.Columns[column].text])
  
  ' colorea la fila, según sea par o impar
  If row = GridViewCurso.row Then 
    'cursor donde esta situado en el gridview
    GridViewCurso.Data.Background = Color.Orange
  Else
    If row Mod 2 = 0 Then GridViewCurso.Data.Background = Color.Cyan
  Endif
  
End

Public Sub ToolButtonImprimir_Click()
  
  If GridViewAlumno.row = -1 Then 
    'no puedo editar ya que no esta el cursor puesto en el gridvies
    Message.Info("Seleccione un alumno")
  Else
    
  Endif
  
End

Public Sub ToolButtonImprimir2_Click()
  
  If GridViewCurso.row = -1 Then 
    'no puedo editar ya que no esta el cursor puesto en el gridvies
    Message.Info("Seleccione un curso")
  Else
    
  Endif
  
End

'Anchos y alto de columnas de los gridview..

Private Sub regillaAlumno()
  
  With GridViewAlumno    
    .Columns[0].width = 40
    .Rows.Height = 40
    .Columns[1].width = 0
    .Columns[2].width = 150
    .Columns[5].width = 125
    .Columns[6].width = 250
    .font.size = 8
  End With
  
End

Private Sub regillaCurso()
  
  With GridViewCurso    
    .Columns[0].width = 0
    .Columns[1].width = 200
  End With
  
End

'-----------------------------------------------------
'Hacer doble click para ver los expedientes...
Public Sub GridViewAlumno_DblClick()
  
  ToolButtonExpediente_Click()
  
End

Public Sub GridViewCurso_DblClick()
  
  ToolButtonExpedienteCurso_Click()
  
End
